<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Executivo Avan√ßado - Duralta</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #030712; color: #e5e7eb; }
        .card { background-color: #111827; border-radius: 0.75rem; border: 1px solid #1f2937; transition: transform 0.2s, box-shadow 0.2s; }
        .card:hover { transform: translateY(-5px); box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.3), 0 4px 6px -2px rgb(0 0 0 / 0.2); }
        .btn-primary { background-color: #4f46e5; color: white; font-weight: 600; padding: 0.75rem 1.5rem; border-radius: 0.5rem; transition: background-color 0.3s, transform 0.2s; }
        .btn-primary:hover { background-color: #6366f1; transform: scale(1.05); }
        .loader-small { border: 2px solid #374151; border-top: 2px solid #6366f1; border-radius: 50%; width: 16px; height: 16px; animation: spin 1s linear infinite; display: inline-block; margin: auto;}
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .tab-btn { padding: 0.75rem 1.5rem; border-radius: 0.5rem; font-weight: 500; cursor: pointer; transition: background-color 0.2s, color 0.2s; border: 2px solid transparent; }
        .tab-btn.active { background-color: #4f46e5; color: white; }
        .tab-btn:not(.active) { background-color: #1f2937; color: #9ca3af; }
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .chart-description { font-size: 0.875rem; color: #9ca3af; margin-top: -0.5rem; margin-bottom: 1rem; }
        .heatmap-table { border-collapse: collapse; width: 100%; }
        .heatmap-table th, .heatmap-table td { border: 1px solid #374151; padding: 8px; text-align: center; }
        #cover-page {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100vh;
            text-align: center;
        }
        #period-filter {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            background-color: #111827;
            padding: 1rem;
            border-radius: 0.75rem;
            border: 1px solid #1f2937;
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.3);
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        .filter-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .filter-label {
            font-size: 0.75rem;
            font-weight: 600;
            color: #9ca3af;
            text-transform: uppercase;
            margin-right: 0.5rem;
        }
        .filter-btn {
            padding: 0.5rem 1rem;
            font-weight: 500;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: background-color 0.2s;
            border: 1px solid #374151;
            color: #9ca3af;
        }
        .filter-btn.active {
            background-color: #4f46e5;
            color: white;
            border-color: #4f46e5;
        }
        
        /* --- ESTILOS DA AN√ÅLISE IA (ACCORDION) --- */
        .insight-box {
            background-color: #1f2937;
            border-left: 4px solid #4f46e5;
            padding: 0;
            border-radius: 0.5rem;
            margin-top: 1.5rem;
            display: flex;
            flex-direction: column;
            align-items: stretch;
            overflow: hidden;
        }
        .insight-toggle {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            padding: 1rem;
            background-color: transparent;
            border: none;
            color: #e5e7eb;
            cursor: pointer;
            text-align: left;
        }
        .insight-toggle:hover .text-indigo-400 {
            text-decoration: underline;
        }
        .toggle-icon {
            font-size: 1.2em;
            transition: transform 0.3s ease;
        }
        .insight-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease-out;
            background-color: #111827;
        }
        .insight-content p {
            padding: 0 1rem 1rem 1rem;
            margin: 0;
            line-height: 1.6;
            color: #d1d5db;
        }
        .insight-content p:first-child {
            padding-top: 0.5rem;
        }
        .insight-content.active {
            max-height: 500px;
            transition: max-height 0.4s ease-in;
        }
    </style>
</head>

<body class="p-4 sm:p-6 lg:p-8">
    <div id="cover-page">
        <img src="https://i.postimg.cc/sD8r8jQ5/Design-sem-nome-5.png" alt="Logo Duralta" class="mb-6 rounded-full border-4 border-indigo-500 shadow-lg h-32 w-32">
        <h1 class="text-5xl font-bold text-white mb-4">Relat√≥rio de Intelig√™ncia Estrat√©gica Duralta</h1>
        <p class="text-gray-400 mt-2 max-w-2xl mx-auto text-lg">Uma an√°lise aprofundada do desempenho hist√≥rico (Per√≠odos 2-4) para impulsionar o planejamento e as decis√µes cr√≠ticas para o Per√≠odo 5. Este dashboard integra dados operacionais, financeiros e de mercado para fornecer insights acion√°veis.</p>
        <button id="start-analysis-btn" class="btn-primary mt-8 text-lg px-8 py-4">Analisar Resultados</button>
    </div>

    <div id="dashboard-container" class="max-w-7xl mx-auto hidden">
        <div id="period-filter" class="hidden">
             <div class="filter-group" id="main-filter-group">
                <span class="filter-label">Analisar:</span>
                <button class="filter-btn" data-period="all" title="Mostra os dados de todos os per√≠odos na linha do tempo. Os KPIs comparam P4 vs P3.">Todos</button>
                <button class="filter-btn" data-period="0" title="Foca a an√°lise nos dados do Per√≠odo 2.">P2</button>
                <button class="filter-btn" data-period="1" title="Foca a an√°lise nos dados do Per√≠odo 3.">P3</button>
                <button class="filter-btn active" data-period="2" title="Foca a an√°lise nos dados do Per√≠odo 4.">P4</button>
            </div>
            <div class="filter-group" id="comparison-filter-group">
                <span class="filter-label">Comparar com:</span>
                <button class="filter-btn active" data-compare="previous" title="Compara o per√≠odo selecionado com o seu per√≠odo imediatamente anterior (ex: P4 vs P3).">Anterior</button>
                <button class="filter-btn" data-compare="0" title="Define o Per√≠odo 2 como a base de compara√ß√£o para os KPIs.">P2</button>
                <button class="filter-btn" data-compare="1" title="Define o Per√≠odo 3 como a base de compara√ß√£o para os KPIs.">P3</button>
            </div>
        </div>

        <header class="text-center mb-10">
            <img src="https://i.postimg.cc/sD8r8jQ5/Design-sem-nome-5.png" alt="Logo Duralta" class="mx-auto mb-4 rounded-full border-2 border-indigo-500 h-24 w-24">
            <h1 class="text-4xl font-bold text-white">Dashboard Executivo Avan√ßado - Duralta</h1>
            <p class="text-gray-400 mt-2">An√°lise Integrada de Desempenho (P2-P4) e Planejamento para o Per√≠odo 5.</p>
        </header>

        <div class="flex flex-wrap justify-center gap-2 mb-8" id="tabs">
            <button class="tab-btn active" data-tab="geral">Resumo Executivo</button>
            <button class="tab-btn" data-tab="comercial">An√°lise Comercial</button>
            <button class="tab-btn" data-tab="operacional">An√°lise Operacional</button>
            <button class="tab-btn" data-tab="financeiro">An√°lise Financeira</button>
            <button class="tab-btn" data-tab="rh_macro">RH & Macroeconomia</button>
        </div>

        <div id="tab-contents">
            <!-- ABA: RESUMO EXECUTIVO -->
            <div id="geral" class="tab-content active">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-10" id="kpi-cards"></div>
                
                <div class="card p-6 mb-8">
                    <h2 class="text-2xl font-semibold mb-2 text-white">Evolu√ß√£o dos Indicadores Chave</h2>
                    <p class="chart-description">Vis√£o geral do desempenho financeiro e de mercado da Duralta.</p>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <div><h3 class="font-semibold text-center text-gray-400 mb-2">üìà Lucro L√≠quido vs. Valor da A√ß√£o</h3><canvas id="lucroAcaoChart"></canvas></div>
                        <div><h3 class="font-semibold text-center text-gray-400 mb-2">üèÜ Market Share vs. Pre√ßo M√©dio</h3><canvas id="marketSharePrecoChart"></canvas></div>
                    </div>
                </div>

                <div class="card p-6 mb-8">
                    <h2 class="text-2xl font-semibold mb-2 text-white">Pareto de Resultados e An√°lise Competitiva</h2>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <div>
                            <h3 class="font-semibold text-center text-gray-400 mb-2">An√°lise de Pareto do Lucro L√≠quido Acumulado</h3>
                            <canvas id="paretoLucroChart"></canvas>
                            <div class="insight-box" id="insight-paretoLucro"></div>
                        </div>
                        <div>
                            <h3 class="font-semibold text-center text-gray-400 mb-2">‚öîÔ∏è Radar de Desempenho Competitivo (P4)</h3>
                            <canvas id="radarChart"></canvas>
                             <div class="overflow-x-auto mt-4">
                                <table class="w-full text-sm text-left text-gray-300">
                                    <thead class="text-xs text-gray-400 uppercase bg-gray-700">
                                        <tr>
                                            <th class="px-4 py-3">Empresa</th>
                                            <th class="px-4 py-3 text-right">Valor A√ß√£o</th>
                                            <th class="px-4 py-3 text-right">Market Share</th>
                                            <th class="px-4 py-3 text-right">Margem Lucro</th>
                                        </tr>
                                    </thead>
                                    <tbody id="competitor-table"></tbody>
                                </table>
                            </div>
                            <div class="insight-box" id="insight-radar"></div>
                        </div>
                    </div>
                </div>
                 <div class="card p-6 mb-8">
                    <h2 class="text-2xl font-semibold mb-2 text-white">üî• Heatmap de Vendas por Regi√£o e Per√≠odo (Unidades)</h2>
                    <p class="chart-description">Este mapa de calor mostra a concentra√ß√£o de nossas vendas. C√©lulas mais brilhantes (verdes) indicam alto volume, enquanto as mais escuras indicam baixo desempenho.</p>
                    <div id="heatmapVendas" class="overflow-x-auto"></div>
                    <div class="insight-box" id="insight-heatmapVendas"></div>
                </div>
                 <div class="card p-6 mb-8">
                    <h2 class="text-2xl font-semibold mb-2 text-white">üèÜ Heatmap de Market Share por Regi√£o e Per√≠odo (%)</h2>
                    <p class="chart-description">Similar ao de vendas, este mapa de calor foca na nossa participa√ß√£o de mercado. Ele √© crucial para entender se estamos crescendo em vendas por m√©rito pr√≥prio ou apenas seguindo o crescimento do mercado.</p>
                    <div id="heatmapMarketShare" class="overflow-x-auto"></div>
                    <div class="insight-box" id="insight-heatmapMarketShare"></div>
                </div>
            </div>

            <!-- ABA: AN√ÅLISE COMERCIAL -->
            <div id="comercial" class="tab-content">
                <div class="card p-6 mb-8">
                     <h2 class="text-2xl font-semibold mb-2 text-white">üó∫Ô∏è Desempenho de Vendas por Regi√£o (P4)</h2>
                    <p class="chart-description">An√°lise comparativa das unidades vendidas em cada regi√£o, essencial para identificar fortalezas, fraquezas e oportunidades geogr√°ficas.</p>
                    <canvas id="regionalSalesChart"></canvas>
                    <div class="insight-box mt-6" id="insight-regionalSales"></div>
                </div>
                 <div class="card p-6 mb-8">
                    <h2 class="text-2xl font-semibold mb-2 text-white">üéØ Elasticidade Pre√ßo-Venda (P4)</h2>
                    <p class="chart-description">Este gr√°fico analisa a rela√ß√£o entre o pre√ßo praticado e o volume de vendas alcan√ßado em cada regi√£o, ajudando a entender a sensibilidade da demanda.</p>
                    <canvas id="precoVendasChart"></canvas>
                    <div class="insight-box" id="insight-precoVendas"></div>
                </div>
                 <div class="card p-6 mb-8">
                    <h2 class="text-2xl font-semibold mb-2 text-white">üìç An√°lise Estrat√©gica: Composi√ß√£o da Receita</h2>
                    <p class="chart-description">Este gr√°fico demonstra a contribui√ß√£o de cada regi√£o para a receita total da empresa, mostrando a evolu√ß√£o da nossa depend√™ncia de cada mercado.</p>
                    <canvas id="receitaRegiaoChart"></canvas>
                    <div class="insight-box" id="insight-receitaRegiao"></div>
                </div>
                <div class="card p-6 mb-8">
                    <h2 class="text-2xl font-semibold mb-2 text-white">üìä Comparativo de Demanda e Vendas</h2>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                          <div>
                            <h3 class="font-semibold text-center text-gray-400 mb-2">Market Share por Empresa (P4)</h3>
                            <canvas id="marketSharePieChart"></canvas>
                        </div>
                        <div>
                           <h3 class="font-semibold text-center text-gray-400 mb-2">Demanda vs. Vendas Duralta</h3>
                           <canvas id="demandaNaoAtendidaChart"></canvas>
                        </div>
                    </div>
                    <div class="insight-box" id="insight-demanda"></div>
                </div>
                 <div class="card p-6 mb-8">
                    <h2 class="text-2xl font-semibold mb-2 text-white">Evolu√ß√£o do Market Share (Total)</h2>
                    <p class="chart-description">Acompanhamento da nossa participa√ß√£o de mercado em compara√ß√£o com os principais concorrentes ao longo do tempo.</p>
                    <canvas id="marketShareTimelineChart"></canvas>
                </div>
                 <div class="card p-6 mb-8">
                      <h2 class="text-2xl font-semibold mb-2 text-white">üì¢ Marketing e For√ßa da Marca</h2>
                      <p class="chart-description">An√°lise do investimento em propaganda e seu retorno na percep√ß√£o da marca ao longo do tempo.</p>
                      <canvas id="marcaPropagandaChart"></canvas>
                      <div class="insight-box" id="insight-marcaPropaganda"></div>
                 </div>
            </div>

            <!-- ABA: AN√ÅLISE OPERACIONAL -->
            <div id="operacional" class="tab-content">
                <div class="card p-6 mb-8">
                    <h2 class="text-2xl font-semibold mb-2 text-white">üè≠ Produ√ß√£o e Estoque</h2>
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                         <div>
                            <h3 class="font-semibold text-center text-gray-400 mb-2">Produ√ß√£o Real vs. Capacidade M√°xima</h3>
                            <canvas id="productionCapacityChart"></canvas>
                            <div class="insight-box" id="insight-productionCapacity"></div>
                        </div>
                        <div>
                           <h3 class="font-semibold text-center text-gray-400 mb-2">Origem da Mat√©ria-Prima (Vis√£o Agregada)</h3>
                           <canvas id="materiaPrimaAreaChart"></canvas>
                            <div class="insight-box" id="insight-materiaPrima"></div>
                        </div>
                    </div>
                </div>
                 <div class="card p-6 mb-8">
                    <h2 class="text-2xl font-semibold mb-2 text-white">üîß Parque Fabril e Custos de Manuten√ß√£o</h2>
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                         <div>
                            <h3 class="font-semibold text-center text-gray-400 mb-2">Evolu√ß√£o das M√°quinas e Idade M√©dia</h3>
                            <canvas id="maquinasChart"></canvas>
                        </div>
                        <div>
                           <h3 class="font-semibold text-center text-gray-400 mb-2">Custo de Manuten√ß√£o Estimado</h3>
                           <canvas id="manutencaoChart"></canvas>
                        </div>
                    </div>
                </div>
                <div class="card p-6 mb-8">
                    <h2 class="text-2xl font-semibold mb-2 text-white">üìâ An√°lise Estrat√©gica: Custos N√£o Planejados</h2>
                    <p class="chart-description">Este gr√°fico compara os custos de manuten√ß√£o com os custos extras gerados por compras emergenciais de mat√©ria-prima.</p>
                    <canvas id="custosEmergenciaisChart"></canvas>
                    <div class="insight-box" id="insight-custosEmergenciais"></div>
                </div>
            </div>
            
            <!-- ABA: AN√ÅLISE FINANCEIRA -->
            <div id="financeiro" class="tab-content">
                 <div class="card p-6 mb-8">
                    <h2 class="text-2xl font-semibold mb-2 text-white">üöÄ An√°lise Estrat√©gica: Alavancagem e Rentabilidade</h2>
                    <p class="chart-description">Correla√ß√£o entre as decis√µes de alavancagem financeira (endividamento), precifica√ß√£o e o impacto no lucro operacional.</p>
                    <canvas id="lucroAlavancagemChart"></canvas>
                    <div class="insight-box" id="insight-lucroAlavancagem"></div>
                </div>
                <div class="card p-6 mb-8">
                    <h2 class="text-2xl font-semibold mb-2 text-white">üí∞ Radar de Sa√∫de Financeira (P4)</h2>
                    <p class="chart-description">Comparativo de indicadores financeiros chave entre a Duralta e concorrentes. Valores maiores s√£o melhores, exceto para Alavancagem (que foi invertida para a visualiza√ß√£o).</p>
                    <canvas id="financeRadarChart"></canvas>
                    <div class="insight-box" id="insight-financeRadar"></div>
                </div>
                 <div class="card p-6 mb-8">
                    <h2 class="text-2xl font-semibold mb-2 text-white">üìä Demonstrativo de Resultados (Evolu√ß√£o)</h2>
                    <p class="chart-description">An√°lise da performance financeira da Duralta, desde a receita bruta at√© o lucro l√≠quido.</p>
                    <canvas id="incomeStatementChart"></canvas>
                </div>
                <div class="card p-6 mb-8">
                    <h2 class="text-2xl font-semibold mb-2 text-white">üåä Fluxo de Caixa e Balan√ßo Patrimonial (P4)</h2>
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                         <div>
                            <h3 class="font-semibold text-center text-gray-400 mb-2">Fluxo de Caixa por Atividades (P4)</h3>
                            <canvas id="cashflowWaterfallP4Chart"></canvas>
                        </div>
                        <div>
                           <h3 class="font-semibold text-center text-gray-400 mb-2">Composi√ß√£o do Ativo (P4)</h3>
                           <canvas id="assetCompositionChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ABA: RH & MACROECONOMIA -->
            <div id="rh_macro" class="tab-content">
                 <div class="card p-6 mb-8">
                    <h2 class="text-2xl font-semibold mb-2 text-white">üë• An√°lise de Recursos Humanos</h2>
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                         <div>
                            <h3 class="font-semibold text-center text-gray-400 mb-2">Evolu√ß√£o da For√ßa de Trabalho e Produtividade</h3>
                            <canvas id="rhChart"></canvas>
                        </div>
                        <div>
                            <h3 class="font-semibold text-center text-gray-400 mb-2">Impacto do Treinamento na Produtividade</h3>
                            <canvas id="rhInvestmentScatterChart"></canvas>
                        </div>
                    </div>
                </div>
                <div class="card p-6 mb-8">
                    <h2 class="text-2xl font-semibold mb-2 text-white">‚öñÔ∏è An√°lise Estrat√©gica: Fatores de Motiva√ß√£o</h2>
                    <p class="chart-description">An√°lise da rela√ß√£o entre a motiva√ß√£o dos funcion√°rios, a carga de trabalho (horas extras) e o sal√°rio base oferecido.</p>
                    <canvas id="motivacaoFatoresChart"></canvas>
                    <div class="insight-box" id="insight-motivacaoFatores"></div>
                </div>
                 <div class="card p-6 mb-8">
                    <h2 class="text-2xl font-semibold mb-2 text-white">Motiva√ß√£o vs. PLR e Cen√°rio Macroecon√¥mico</h2>
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                         <div>
                            <h3 class="font-semibold text-center text-gray-400 mb-2">Motiva√ß√£o vs. Investimento em PLR</h3>
                            <canvas id="motivationPlrChart"></canvas>
                        </div>
                        <div>
                           <h3 class="font-semibold text-center text-gray-400 mb-2">üåç Indicadores Macroecon√¥micos</h3>
                           <canvas id="macroChart"></canvas>
                        </div>
                    </div>
                        <div class="insight-box" id="insight-motivacaoPlr"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DATA HUB ---
            const simulationData = {
                periodos: ["Per√≠odo 2", "Per√≠odo 3", "Per√≠odo 4"],
                regioes: ["Regi√£o 1", "Regi√£o 2", "Regi√£o 3", "Regi√£o 4", "Regi√£o 5", "Regi√£o 6"],
                duralta: {
                    decisoes: {
                        p2: { precoMedio: 463, propaganda: 17, juros: 3.0, nivelAtividade: 100, prodExtra: 3, compraMPA: 35000, compraMPB: 22000, compraMaq: "Nenhuma", emprestimo: 0, aplicacao: 0, admissoes: 0, demissoes: 0, salario: 3100, treinamento: 4, plr: 0 },
                        p3: { precoMedio: 471, propaganda: 10, juros: 1.5, nivelAtividade: 100, prodExtra: 0, compraMPA: 26000, compraMPB: 21000, compraMaq: "Nenhuma", emprestimo: 0, aplicacao: 0, admissoes: 0, demissoes: 10, salario: 3100, treinamento: 3, plr: 2 },
                        p4: { precoMedio: 517, propaganda: 6, juros: 3.5, nivelAtividade: 100, prodExtra: 25, compraMPA: 63781, compraMPB: 43566, compraMaq: "1 Alfa", emprestimo: 1000000, aplicacao: 20000, admissoes: 20, demissoes: 0, salario: 3150, treinamento: 5, plr: 3 }
                    },
                    demanda: [14992, 15085, 7413],
                    lucroLiquido: [245589, 391782, 955247], lucroBruto: [1556658, 1602393, 2397236], lucroOperacional: [332928, 514326, 1202577],
                    valorAcao: [67.25, 76.89, 75.04], marketShare: [25.94, 29.22, 28.34],
                    vendas: [10506, 10300, 13125], producao: [10506, 10300, 13125], capacidade: [12881, 12875, 15750], 
                    produtividade: [1.02, 1.03, 1.05],
                    endividamentoTotal: [2000000, 2000000, 3300000], caixaFinal: [585341, 62254, 1178478],
                    fluxoCaixaP4: { inicial: 62254, operacional: 478170, investimento: -520000, financiamento: 1158055, final: 1178478 },
                    balancoP4: { caixa: 1178478, aplicacao: 20000, clientes: 4220466, estoque: 3134443, imobilizado: 3926400, passivo: 5831771, patrimonioLiquido: 7448015},
                    cpv: { p2: 3411544, p3: 3293605, p4: 4504422, composicaoP4: { maoDeObra: 2532600, materiaPrima: 1847427, outros: 124395 } },
                    rh: { empregados: [470, 460, 480], salario: [3100, 3100, 3150], treinamento: [4, 3, 5], motivacao: [3, 3, 3], prodExtra: [3, 0, 25] },
                    maquinas: { alfa: [5, 5, 6], idadeMedia: [15, 16, 14.17], custoManutencao: [154500, 160000, 212500] },
                    marketing: { propaganda: [17, 10, 6], forcaMarca: [1, 1, 2] },
                    operacional: { mp_a_emergencial: [1518, 0, 9275], mp_a_programada: [30000, 30900, 30100] },
                    vendasRegionais: { p2: [923, 2154, 1402, 1323, 1649, 3055], p3: [1190, 2399, 1290, 1272, 1668, 2481], p4: [3745, 2497, 2019, 2000, 1427, 1437] },
                    precosRegionais: {p2: [457, 463, 469, 455, 469, 463], p3: [475, 455, 479, 466, 475, 477], p4: [520, 520, 520, 500, 520, 520]},
                },
                competitors: {
                    'Luminous SA': { marketShare: [23.70, 28.79, 22.46], vendas: [9600, 10148, 10405], caixaFinal: [557816, 916741, 1849408] },
                    'Sweet Tooth': { marketShare: [25.18, 27.52, 26.95] },
                    'Empresa 5': { marketShare: [25.18, 14.47, 22.24] }
                },
                competitorsP4: {
                    'Duralta': { valorAcao: 75.04, marketShare: 28.34, margemLucro: 13.84, precoMedio: 517, roe: 12.8, liquidez: 1.55, alavancagem: 0.44 },
                    'Luminous SA': { valorAcao: 79.80, marketShare: 22.46, margemLucro: 16.3, precoMedio: 503, vendasRegionais: [2274, 1994, 1134, 1082, 2663, 1253], precosRegionais: [505, 510, 490, 495, 510, 505], roe: 13.2, liquidez: 1.93, alavancagem: 0.35 },
                    'Sweet Tooth': { valorAcao: 79.80, marketShare: 26.95, margemLucro: 16.32, precoMedio: 510, roe: 13.18, liquidez: 1.93, alavancagem: 0.54 },
                    'Empresa 5': { valorAcao: 54.22, marketShare: 22.24, margemLucro: 8.9, precoMedio: 466, vendasRegionais: [1359, 1314, 1626, 1365, 2555, 2079], precosRegionais: [465, 465, 465, 465, 470, 465], roe: 0, liquidez: 1.56, alavancagem: 2 }
                },
                mercado: { macro: { selic: [1.2, 1.2, 1.2], inflacao: [1.0, 1.0, 1.0], inadimplencia: [3.2, 3.2, 3.1] } }
            };
            
            const GEMINI_API_KEY = "";
            let chartInstances = {};
            let selectedPeriod = '2'; 
            let comparisonPeriod = 'previous';

            // --- DADOS CALCULADOS ADICIONAIS ---
            simulationData.duralta.receitaPorRegiao = {
                p2: simulationData.duralta.vendasRegionais.p2.map((v, i) => v * simulationData.duralta.precosRegionais.p2[i]),
                p3: simulationData.duralta.vendasRegionais.p3.map((v, i) => v * simulationData.duralta.precosRegionais.p3[i]),
                p4: simulationData.duralta.vendasRegionais.p4.map((v, i) => v * simulationData.duralta.precosRegionais.p4[i])
            };
            simulationData.duralta.custoCompraEmergencial = [
                simulationData.duralta.operacional.mp_a_emergencial[0] * 20 * 1.5,
                simulationData.duralta.operacional.mp_a_emergencial[1] * 20 * 1.5,
                simulationData.duralta.operacional.mp_a_emergencial[2] * 20 * 1.5
            ];

            // --- L√ìGICA DE INICIALIZA√á√ÉO E EVENTOS ---
            function initializeDashboard() {
                document.getElementById('tabs').addEventListener('click', handleTabClick);
                document.getElementById('start-analysis-btn').addEventListener('click', showDashboard);
                document.getElementById('period-filter').addEventListener('click', handleFilterClick);
                document.getElementById('dashboard-container').addEventListener('click', handleAccordionToggle);
            }

            function handleTabClick(e) {
                if (e.target.tagName === 'BUTTON') {
                    const targetTab = e.target.dataset.tab;
                    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                    e.target.classList.add('active');
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    document.getElementById(targetTab).classList.add('active');
                }
            }

            function showDashboard() {
                document.getElementById('cover-page').classList.add('hidden');
                document.getElementById('dashboard-container').classList.remove('hidden');
                document.getElementById('period-filter').classList.remove('hidden');
                renderFullDashboard();
            }

            function handleFilterClick(e) {
                const button = e.target.closest('.filter-btn');
                if (!button) return;

                if (button.dataset.period) {
                    selectedPeriod = button.dataset.period;
                    document.querySelectorAll('#main-filter-group .filter-btn').forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                    updateCharts(selectedPeriod);
                } else if (button.dataset.compare) {
                    comparisonPeriod = button.dataset.compare;
                    document.querySelectorAll('#comparison-filter-group .filter-btn').forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                }
                updateKPIs();
            }

            function handleAccordionToggle(e) {
                const toggle = e.target.closest('.insight-toggle');
                if (toggle) {
                    const content = toggle.nextElementSibling;
                    const icon = toggle.querySelector('.toggle-icon');
                    if (content && content.classList.contains('insight-content')) {
                        content.classList.toggle('active');
                        icon.style.transform = content.classList.contains('active') ? 'rotate(180deg)' : 'rotate(0deg)';
                    }
                }
            }
            
            function updateKPIs() {
                const kpiContainer = document.getElementById('kpi-cards');
                kpiContainer.innerHTML = '';
                
                let currentIdx = selectedPeriod === 'all' ? 2 : parseInt(selectedPeriod, 10);
                let previousIdx;

                if (comparisonPeriod === 'previous') {
                    previousIdx = Math.max(0, currentIdx - 1);
                } else {
                    previousIdx = parseInt(comparisonPeriod, 10);
                }
                
                const comparisonLabel = `P${previousIdx + 2}`;
                
                const kpiData = [
                     { title: `üí∞ Lucro L√≠quido (P${currentIdx + 2})`, value: simulationData.duralta.lucroLiquido[currentIdx], prevValue: simulationData.duralta.lucroLiquido[previousIdx], format: 'currency' },
                    { title: `üìà Valor da A√ß√£o (P${currentIdx + 2})`, value: simulationData.duralta.valorAcao[currentIdx], prevValue: simulationData.duralta.valorAcao[previousIdx], format: 'currency' },
                    { title: `üèÜ Market Share (P${currentIdx + 2})`, value: simulationData.duralta.marketShare[currentIdx], prevValue: simulationData.duralta.marketShare[previousIdx], format: 'percent' },
                    { title: `üòï Motiva√ß√£o (P${currentIdx + 2})`, value: "Regular", prevValue: "Regular", format: 'text' }
                ];

                kpiData.forEach(kpi => {
                    let change = 0;
                    if (kpi.format !== 'text' && currentIdx !== previousIdx && kpi.prevValue !== 0) {
                        change = ((kpi.value - kpi.prevValue) / Math.abs(kpi.prevValue)) * 100;
                    }
                    const isNegative = change < 0;
                    const trendIcon = isNegative ? '‚¨áÔ∏è' : '‚¨ÜÔ∏è', trendColor = isNegative ? 'text-red-400' : 'text-green-400';
                    const formattedValue = kpi.format === 'currency' ? `$${kpi.value.toLocaleString('pt-BR')}` : kpi.format === 'percent' ? `${kpi.value.toFixed(2)}%` : kpi.value;
                    let changeText;
                     if (kpi.format === 'text') {
                        changeText = `<span class="text-yellow-400 text-sm font-semibold">‚ö†Ô∏è Ponto de Aten√ß√£o</span>`;
                    } else if (currentIdx === previousIdx) {
                        changeText = `<span class="text-gray-400 text-sm font-semibold">Base de compara√ß√£o</span>`;
                    } else {
                        changeText = `<span class="${trendColor} text-sm font-semibold">${trendIcon} ${change.toFixed(2)}% vs ${comparisonLabel}</span>`;
                    }

                    kpiContainer.innerHTML += `<div class="card p-4"><h3 class="text-gray-400 text-sm font-medium">${kpi.title}</h3><p class="text-white text-3xl font-bold mt-1">${formattedValue}</p><p class="mt-2">${changeText}</p></div>`;
                });
            }


            function renderFullDashboard() {
                updateKPIs();
                const heatmapContainer = document.getElementById('heatmapVendas');
                let heatmapHtml = '<table class="heatmap-table"><thead><tr><th>&nbsp;</th>';
                simulationData.regioes.forEach(r => heatmapHtml += `<th>${r}</th>`);
                heatmapHtml += '</tr></thead><tbody>';
                const allSales = [...simulationData.duralta.vendasRegionais.p2, ...simulationData.duralta.vendasRegionais.p3, ...simulationData.duralta.vendasRegionais.p4];
                const minSales = Math.min(...allSales), maxSales = Math.max(...allSales);
                const salesData = [simulationData.duralta.vendasRegionais.p2, simulationData.duralta.vendasRegionais.p3, simulationData.duralta.vendasRegionais.p4];
                salesData.forEach((periodo, i) => {
                    heatmapHtml += `<tr><td class="font-bold">P${i+2}</td>`;
                    periodo.forEach(venda => {
                        const percentage = (venda - minSales) / (maxSales - minSales) || 0;
                        const color = `rgba(34, 197, 94, ${percentage})`;
                        heatmapHtml += `<td style="background-color: ${color}; color: ${percentage > 0.6 ? 'white' : '#111827'}">${venda.toLocaleString('pt-BR')}</td>`;
                    });
                    heatmapHtml += '</tr>';
                });
                heatmapHtml += '</tbody></table>';
                heatmapContainer.innerHTML = heatmapHtml;

                const heatmapMsContainer = document.getElementById('heatmapMarketShare');
                let heatmapMsHtml = '<table class="heatmap-table"><thead><tr><th>&nbsp;</th>';
                simulationData.regioes.forEach(r => heatmapMsHtml += `<th>${r}</th>`);
                heatmapMsHtml += '</tr></thead><tbody>';
                const msData = [[13.38, 36.47, 21.96, 24.95, 23.66, 33.78], [16.26, 41.82, 31.37, 32.19, 24.29, 34.15], [41.65, 33.89, 24.01, 32.97, 17.13, 20.13]];
                const allMs = msData.flat();
                const minMs = Math.min(...allMs), maxMs = Math.max(...allMs);
                msData.forEach((periodo, i) => {
                    heatmapMsHtml += `<tr><td class="font-bold">P${i+2}</td>`;
                    periodo.forEach(ms => {
                        const percentage = (ms - minMs) / (maxMs - minMs) || 0;
                        const color = `rgba(79, 70, 229, ${percentage})`;
                        heatmapMsHtml += `<td style="background-color: ${color}; color: ${percentage > 0.6 ? 'white' : '#e5e7eb'}">${ms.toFixed(2)}%</td>`;
                    });
                    heatmapMsHtml += '</tr>';
                });
                heatmapMsHtml += '</tbody></table>';
                heatmapMsContainer.innerHTML = heatmapMsHtml;

                createAllCharts();
                updateCharts(selectedPeriod);
                generateAllInsights();
            }
            
            function createAllCharts() {
                Object.values(chartInstances).forEach(chart => chart.destroy());
                chartInstances = {};

                Chart.defaults.color = '#9ca3af'; Chart.defaults.borderColor = '#374151';
                const commonLineOptions = { tension: 0.3, borderWidth: 3, pointBackgroundColor: '#fff', pointRadius: 4, pointHoverRadius: 6 };
                
                const chartsToCreate = {
                    lucroAcaoChart: { type: 'bar', data: { labels: simulationData.periodos, datasets: [{ label: 'Lucro L√≠quido ($)', data: simulationData.duralta.lucroLiquido, backgroundColor: 'rgba(79, 70, 229, 0.7)', yAxisID: 'y' }, { label: 'Valor da A√ß√£o ($)', data: simulationData.duralta.valorAcao, type: 'line', borderColor: '#f59e0b', yAxisID: 'y1', ...commonLineOptions }] }, options: { scales: { y: { beginAtZero: true, position: 'left', title: { display: true, text: 'Lucro L√≠quido' } }, y1: { position: 'right', title: { display: true, text: 'Valor da A√ß√£o' }, grid: { drawOnChartArea: false } } } } },
                    marketSharePrecoChart: { type: 'bar', data: { labels: simulationData.periodos, datasets: [{ label: 'Market Share (%)', data: simulationData.duralta.marketShare, backgroundColor: 'rgba(16, 185, 129, 0.7)', yAxisID: 'y' }, { label: 'Pre√ßo M√©dio Duralta ($)', data: [463, 471, 517], type: 'line', borderColor: '#ec4899', yAxisID: 'y1', ...commonLineOptions }] }, options: { scales: { y: { position: 'left', title: { display: true, text: 'Market Share (%)' } }, y1: { position: 'right', title: { display: true, text: 'Pre√ßo M√©dio ($)' }, grid: { drawOnChartArea: false } } } } },
                    paretoLucroChart: { type: 'bar', data: { labels: simulationData.periodos, datasets: [{ label: 'Lucro por Per√≠odo', data: simulationData.duralta.lucroLiquido, backgroundColor: '#3b82f6' }, { label: '% Acumulada', data: simulationData.duralta.lucroLiquido.map((val, i) => simulationData.duralta.lucroLiquido.slice(0, i + 1).reduce((a, b) => a + b, 0) / simulationData.duralta.lucroLiquido.reduce((a, b) => a + b, 0) * 100), type: 'line', borderColor: '#ef4444', yAxisID: 'y1', ...commonLineOptions }] }, options: { scales: { y: { title: { display: true, text: 'Lucro ($)' } }, y1: { position: 'right', max: 100, title: { display: true, text: '% Acumulada' }, grid: { drawOnChartArea: false } } } } },
                    regionalSalesChart: { type: 'bar', data: { labels: simulationData.regioes, datasets: [{ label: 'Duralta', data: simulationData.duralta.vendasRegionais.p4, backgroundColor: '#4f46e5' }, { label: 'Luminous SA', data: simulationData.competitorsP4['Luminous SA'].vendasRegionais, backgroundColor: '#059669' }, { label: 'Empresa 5', data: simulationData.competitorsP4['Empresa 5'].vendasRegionais, backgroundColor: '#db2777' }] } },
                    precoVendasChart: { type: 'bar', data: { labels: simulationData.regioes, datasets: [ { label: 'Unidades Vendidas', data: simulationData.duralta.vendasRegionais.p4, backgroundColor: '#22d3ee', yAxisID: 'y', }, { label: 'Pre√ßo de Venda ($)', data: simulationData.duralta.precosRegionais.p4, type: 'line', borderColor: '#f97316', yAxisID: 'y1', ...commonLineOptions } ] }, options: { scales: { y: { position: 'left', title: { display: true, text: 'Unidades Vendidas' } }, y1: { position: 'right', title: { display: true, text: 'Pre√ßo de Venda ($)' }, grid: { drawOnChartArea: false } } } } },
                    marketSharePieChart: { type: 'pie', data: { labels: Object.keys(simulationData.competitorsP4), datasets: [{ label: 'Market Share (P4)', data: Object.values(simulationData.competitorsP4).map(c => c.marketShare), backgroundColor: ['#4f46e5', '#059669', '#f59e0b', '#db2777'] }] } },
                    demandaNaoAtendidaChart: { type: 'bar', data: { labels: simulationData.periodos, datasets: [{ label: 'Demanda Total', data: simulationData.duralta.demanda, backgroundColor: '#8b5cf6' }, { label: 'Vendas Realizadas', data: simulationData.duralta.vendas, backgroundColor: '#10b981' }] } },
                    marketShareTimelineChart: { type: 'line', data: { labels: simulationData.periodos, datasets: [{ label: 'Duralta', data: simulationData.duralta.marketShare, borderColor: '#4f46e5', ...commonLineOptions }, { label: 'Luminous SA', data: simulationData.competitors['Luminous SA'].marketShare, borderColor: '#059669', ...commonLineOptions }, { label: 'Sweet Tooth', data: simulationData.competitors['Sweet Tooth'].marketShare, borderColor: '#f59e0b', ...commonLineOptions }, { label: 'Empresa 5', data: simulationData.competitors['Empresa 5'].marketShare, borderColor: '#db2777', ...commonLineOptions }] }, options: { scales: { y: { title: { display: true, text: 'Market Share (%)' } } } } },
                    marcaPropagandaChart: { type: 'bar', data: { labels: simulationData.periodos, datasets: [{ label: 'N¬∫ Campanhas', data: simulationData.duralta.marketing.propaganda, backgroundColor: '#8b5cf6', yAxisID: 'y' }, { label: 'For√ßa da Marca', data: simulationData.duralta.marketing.forcaMarca, type: 'line', stepped: true, borderColor: '#f87171', yAxisID: 'y1', ...commonLineOptions }] }, options: { scales: { y: { position: 'left', title: { display: true, text: 'N¬∫ Campanhas' } }, y1: { position: 'right', title: { display: true, text: 'For√ßa da Marca (2=Forte)' }, grid: { drawOnChartArea: false }, ticks: { stepSize: 1 } } } } },
                    productionCapacityChart: { type: 'bar', data: { labels: simulationData.periodos, datasets: [{ label: 'Produ√ß√£o Real', data: simulationData.duralta.producao, backgroundColor: 'rgba(14, 165, 233, 0.7)' }, { label: 'Capacidade M√°xima (com HE)', data: simulationData.duralta.capacidade, type: 'line', borderColor: '#e11d48', ...commonLineOptions, fill: false }] } },
                    materiaPrimaAreaChart: { type: 'line', data: { labels: simulationData.periodos, datasets: [{ label: 'Programada', data: simulationData.duralta.operacional.mp_a_programada, borderColor: '#1d4ed8', fill: true, backgroundColor: '#1d4ed833', ...commonLineOptions}, { label: 'Emergencial', data: simulationData.duralta.operacional.mp_a_emergencial, borderColor: '#be123c', fill: true, backgroundColor: '#be123c33', ...commonLineOptions }] }, options: { scales: { y: { stacked: true, title: { display: true, text: 'Unidades Consumidas' } } } } },
                    maquinasChart: { type: 'bar', data: { labels: simulationData.periodos, datasets: [{ label: 'Qtd M√°quinas Alfa', data: simulationData.duralta.maquinas.alfa, backgroundColor: '#d946ef', yAxisID: 'y' }, { label: 'Idade M√©dia', data: simulationData.duralta.maquinas.idadeMedia, type: 'line', borderColor: '#e11d48', yAxisID: 'y1', ...commonLineOptions }] }, options: { scales: { y: { position: 'left', title: { display: true, text: 'Quantidade' } }, y1: { position: 'right', title: { display: true, text: 'Idade M√©dia (Per√≠odos)' }, grid: { drawOnChartArea: false } } } } },
                    manutencaoChart: { type: 'line', data: { labels: simulationData.periodos, datasets: [{ label: 'Custo Manuten√ß√£o ($)', data: simulationData.duralta.maquinas.custoManutencao, borderColor: '#f97316', ...commonLineOptions, fill: true, backgroundColor: 'rgba(249, 115, 22, 0.2)' }] } },
                    incomeStatementChart: { type: 'line', data: { labels: simulationData.periodos, datasets: [{ label: 'Lucro Bruto', data: simulationData.duralta.lucroBruto, borderColor: '#22c55e', ...commonLineOptions }, { label: 'Lucro Operacional', data: simulationData.duralta.lucroOperacional, borderColor: '#3b82f6', ...commonLineOptions }, { label: 'Lucro L√≠quido', data: simulationData.duralta.lucroLiquido, borderColor: '#f59e0b', ...commonLineOptions }] } },
                    cashflowWaterfallP4Chart: { type: 'bar', data: { labels: ['Saldo Inicial', 'Operacional', 'Investimento', 'Financiamento', 'Saldo Final'], datasets: [{ label: 'Fluxo de Caixa (P4)', data: [simulationData.duralta.fluxoCaixaP4.inicial, simulationData.duralta.fluxoCaixaP4.operacional, simulationData.duralta.fluxoCaixaP4.investimento, simulationData.duralta.fluxoCaixaP4.financiamento, simulationData.duralta.fluxoCaixaP4.final].reduce((acc, val, i) => { const prev = i > 0 ? acc[i - 1][1] : 0; acc.push([prev, prev + val]); return acc; }, []), backgroundColor: ['#16a34a', '#16a34a', '#ef4444', '#3b82f6', '#16a34a'] }] }, options: { indexAxis: 'y' } },
                    assetCompositionChart: { type: 'doughnut', data: { labels: ['Caixa e Aplica√ß√µes', 'Contas a Receber', 'Estoque', 'Imobilizado'], datasets: [{ data: [simulationData.duralta.balancoP4.caixa + simulationData.duralta.balancoP4.aplicacao, simulationData.duralta.balancoP4.clientes, simulationData.duralta.balancoP4.estoque, simulationData.duralta.balancoP4.imobilizado], backgroundColor: ['#0ea5e9', '#f97316', '#eab308', '#8b5cf6'] }] } },
                    rhChart: { type: 'bar', data: { labels: simulationData.periodos, datasets: [{ label: 'N¬∫ Empregados', data: simulationData.duralta.rh.empregados, backgroundColor: '#fbbf24', yAxisID: 'y' }, { label: 'Produtividade', data: simulationData.duralta.produtividade, type: 'line', borderColor: '#22c55e', yAxisID: 'y1', ...commonLineOptions }] }, options: { scales: { y: { position: 'left', title: { display: true, text: 'N¬∫ Empregados' } }, y1: { position: 'right', title: { display: true, text: '√çndice' }, grid: { drawOnChartArea: false } } } } },
                    rhInvestmentScatterChart: { type: 'bar', data: { labels: simulationData.periodos, datasets: [{ label: 'Investimento em Treinamento (%)', data: simulationData.duralta.rh.treinamento, backgroundColor: '#a855f7', yAxisID: 'y'}, { label: '√çndice de Produtividade', data: simulationData.duralta.produtividade, type: 'line', borderColor: '#22c55e', yAxisID: 'y1', ...commonLineOptions }] }, options: { scales: { y: { position: 'left', title: { display: true, text: 'Investimento em Treinamento (%)' } }, y1: { position: 'right', title: { display: true, text: '√çndice de Produtividade' }, grid: { drawOnChartArea: false } } } } },
                    motivationPlrChart: { type: 'bar', data: { labels: simulationData.periodos, datasets: [{ label: 'Investimento em PLR (%)', data: [simulationData.duralta.decisoes.p2.plr, simulationData.duralta.decisoes.p3.plr, simulationData.duralta.decisoes.p4.plr].map(p => p === 0 ? null : p), backgroundColor: '#f43f5e', yAxisID: 'y' }, { label: 'Motiva√ß√£o', data: simulationData.duralta.rh.motivacao, type: 'line', stepped: true, borderColor: '#facc15', yAxisID: 'y1', ...commonLineOptions }] }, options: { scales: { y: { position: 'left', title: { display: true, text: 'PLR (%)' } }, y1: { position: 'right', title: { display: true, text: 'N√≠vel de Motiva√ß√£o' }, grid: { drawOnChartArea: false }, ticks: { stepSize: 1, callback: (v) => ['','P√©ssimo','Ruim','Regular','Bom','√ìtimo'][v] || '' } } } } },
                    macroChart: { type: 'line', data: { labels: simulationData.periodos, datasets: [{ label: 'Selic (%)', data: simulationData.mercado.macro.selic, borderColor: '#38bdf8', ...commonLineOptions }, { label: 'Infla√ß√£o (%)', data: simulationData.mercado.macro.inflacao, borderColor: '#f472b6', ...commonLineOptions }, { label: 'Inadimpl√™ncia M√©dia (%)', data: simulationData.mercado.macro.inadimplencia, borderColor: '#facc15', ...commonLineOptions }] } },
                    lucroAlavancagemChart: { type: 'bar', data: { labels: simulationData.periodos, datasets: [{ label: 'Lucro Operacional ($)', data: simulationData.duralta.lucroOperacional, backgroundColor: 'rgba(34, 197, 94, 0.7)', yAxisID: 'y' }, { label: 'Endividamento Total ($)', data: simulationData.duralta.endividamentoTotal, type: 'line', borderColor: '#ef4444', yAxisID: 'y1', ...commonLineOptions }, { label: 'Pre√ßo M√©dio ($)', data: [simulationData.duralta.decisoes.p2.precoMedio, simulationData.duralta.decisoes.p3.precoMedio, simulationData.duralta.decisoes.p4.precoMedio], type: 'line', borderColor: '#3b82f6', yAxisID: 'y2', ...commonLineOptions }] }, options: { scales: { y: { position: 'left', title: { display: true, text: 'Lucro Operacional' } }, y1: { position: 'right', title: { display: true, text: 'Endividamento' }, grid: { drawOnChartArea: false } }, y2: { display: false } } } },
                    receitaRegiaoChart: { type: 'bar', data: { labels: simulationData.periodos, datasets: simulationData.regioes.map((regiao, i) => ({ label: regiao, data: [simulationData.duralta.receitaPorRegiao.p2[i], simulationData.duralta.receitaPorRegiao.p3[i], simulationData.duralta.receitaPorRegiao.p4[i]], backgroundColor: `hsl(${i * 60}, 70%, 50%)` })) }, options: { scales: { x: { stacked: true }, y: { stacked: true, title: { display: true, text: 'Receita ($)' } } } } },
                    custosEmergenciaisChart: { type: 'bar', data: { labels: simulationData.periodos, datasets: [{ label: 'Custo Compra Emergencial ($)', data: simulationData.duralta.custoCompraEmergencial, backgroundColor: '#f97316' }, { label: 'Custo Manuten√ß√£o ($)', data: simulationData.duralta.maquinas.custoManutencao, backgroundColor: '#f43f5e' }] }, options: { scales: { y: { title: { display: true, text: 'Custo ($)' } } } } },
                    motivacaoFatoresChart: { type: 'bar', data: { labels: simulationData.periodos, datasets: [{ label: 'Motiva√ß√£o (N√≠vel)', data: simulationData.duralta.rh.motivacao, backgroundColor: 'rgba(234, 179, 8, 0.7)', yAxisID: 'y' }, { label: 'Produ√ß√£o Extra (%)', data: simulationData.duralta.rh.prodExtra, type: 'line', borderColor: '#ef4444', yAxisID: 'y1', ...commonLineOptions }, { label: 'Sal√°rio Base ($)', data: simulationData.duralta.rh.salario, type: 'line', borderColor: '#3b82f6', yAxisID: 'y2', ...commonLineOptions, pointStyle: 'rect' }] }, options: { scales: { y: { position: 'left', title: { display: true, text: 'N√≠vel Motiva√ß√£o' }, ticks: { stepSize: 1, callback: (v) => ['','P√©ssimo','Ruim','Regular','Bom','√ìtimo'][v] || '' } }, y1: { position: 'right', title: { display: true, text: '% Produ√ß√£o Extra' }, grid: { drawOnChartArea: false } }, y2: { position: 'right', title: {display: true, text: 'Sal√°rio ($)'}, grid: {drawOnChartArea: false}, ticks: {display: false} } } } }
                };
                
                const financeRadarData = { labels: ['Liquidez', 'ROE', 'Margem L√≠quida', 'Alavancagem (Invertido)'], datasets: [] };
                const financeCompanyColors = { 'Duralta': '#4f46e5', 'Luminous SA': '#059669', 'Sweet Tooth': '#f59e0b', 'Empresa 5': '#db2777' };
                for(const name in simulationData.competitorsP4){
                    const company = simulationData.competitorsP4[name];
                    financeRadarData.datasets.push({
                        label: name,
                        data: [ company.liquidez, company.roe, company.margemLucro, (1 / company.alavancagem)],
                        borderColor: financeCompanyColors[name], backgroundColor: `${financeCompanyColors[name]}33`
                    });
                }
                chartsToCreate.radarChart = { type: 'radar', data: financeRadarData, options: { scales: { r: { suggestedMin: 0, suggestedMax: 1, ticks: { display: false } } } } };
                chartsToCreate.financeRadarChart = { type: 'radar', data: financeRadarData, options: { scales: { r: { suggestedMin: 0 } } } };

                for (const id in chartsToCreate) {
                    const ctx = document.getElementById(id).getContext('2d');
                    const chartConfig = chartsToCreate[id];
                    chartInstances[id] = new Chart(ctx, chartConfig);
                    chartInstances[id].originalConfig = JSON.parse(JSON.stringify(chartConfig));
                }
                
                const competitorTable = document.getElementById('competitor-table');
                competitorTable.innerHTML = '';
                for (const name in simulationData.competitorsP4) {
                    const data = simulationData.competitorsP4[name];
                    competitorTable.innerHTML += `<tr class="bg-gray-800 border-b-2 border-gray-900 hover:bg-gray-700"><th class="px-4 py-3 font-medium" style="color:${financeCompanyColors[name]}">${name}</th><td class="px-4 py-3 text-right">$${data.valorAcao.toFixed(2)}</td><td class="px-4 py-3 text-right">${data.marketShare.toFixed(2)}%</td><td class="px-4 py-3 text-right">${data.margemLucro.toFixed(2)}%</td></tr>`;
                }
            }
            
            function updateCharts(period) {
                const periodIndex = period === 'all' ? -1 : parseInt(period, 10);
                
                for (const chartId in chartInstances) {
                    const chart = chartInstances[chartId];
                    const originalConfig = chart.originalConfig; 

                    if (originalConfig && JSON.stringify(originalConfig.data.labels) === JSON.stringify(simulationData.periodos)) {
                        
                        if (periodIndex !== -1) {
                            chart.data.labels = [originalConfig.data.labels[periodIndex]];
                            chart.data.datasets.forEach((dataset, i) => {
                                const originalDataset = originalConfig.data.datasets[i];
                                if (originalDataset && originalDataset.data) {
                                    dataset.data = [originalDataset.data[periodIndex]];
                                }
                            });
                        } else { 
                            chart.data.labels = originalConfig.data.labels;
                            chart.data.datasets.forEach((dataset, i) => {
                                 const originalDataset = originalConfig.data.datasets[i];
                                 if (originalDataset && originalDataset.data) {
                                    dataset.data = originalDataset.data;
                                 }
                            });
                        }
                        chart.update();
                    }
                }
            }

            // --- L√ìGICA DA IA ---
            async function callGeminiApi(prompt) {
                const model = 'gemini-2.5-flash-preview-05-20';
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${GEMINI_API_KEY}`;
                
                for (let i = 0; i < 3; i++) {
                    try {
                        const response = await fetch(apiUrl, { 
                            method: 'POST', 
                            headers: { 'Content-Type': 'application/json' }, 
                            body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] }) 
                        });
                        
                        if (!response.ok) { 
                            if (response.status === 429) {
                                console.warn(`Quota exceeded, retrying in ${ (i + 1) * 2000 }ms...`);
                                await new Promise(res => setTimeout(res, (i + 1) * 2000));
                                continue;
                            }
                            const err = await response.json(); 
                            throw new Error(`HTTP error ${response.status}: ${err.error?.message || 'Unknown error'}`); 
                        }
                        
                        const data = await response.json();
                        
                        if (data.candidates && data.candidates.length > 0 && data.candidates[0].content?.parts?.length > 0) {
                             return data.candidates[0].content.parts[0].text;
                        }
                        return "N√£o foi poss√≠vel gerar a an√°lise. Resposta da API inv√°lida.";
                    } catch (e) {
                        console.error(`Error in Gemini API call (attempt ${i+1}):`, e);
                        if (i === 2) {
                           return `Erro ao contatar a IA: ${e.message}`;
                        }
                    }
                }
            }

            async function generateInsight(elementId, prompt) {
                const container = document.getElementById(elementId);
                if (!container) return;
                
                container.innerHTML = `
                    <button class="insight-toggle">
                        <span class="text-indigo-400 font-semibold">Ver An√°lise de IA</span>
                        <span class="toggle-icon">‚ñº</span>
                    </button>
                    <div class="insight-content">
                        <div class="p-4 flex justify-center items-center"><div class="loader-small"></div></div>
                    </div>
                `;

                const response = await callGeminiApi(prompt);
                const contentDiv = container.querySelector('.insight-content');
                if (contentDiv) {
                    const formattedResponse = response
                        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                        .split('\n')
                        .filter(p => p.trim() !== '')
                        .map(p => `<p>${p.replace(/\*/g, '')}</p>`)
                        .join('');
                    contentDiv.innerHTML = formattedResponse;
                }
            }

            async function generateAllInsights() {
                const insightPrompts = {
                    'insight-paretoLucro': `Baseado nos lucros l√≠quidos da Duralta ([${simulationData.duralta.lucroLiquido.join(', ')}]), qual foi o per√≠odo mais decisivo e por qu√™? Seja conciso.`,
                    'insight-radar': `Compare a Duralta (Market Share: 28.34, Margem: 13.84) com a Luminous SA (Market Share: 22.46, Margem: 16.3) e a Empresa 5 (Market Share: 22.24, Pre√ßo M√©dio: 466). Quais os pontos fortes e fracos da Duralta? Responda em 2 frases.`,
                    'insight-heatmapVendas': `Analisando as vendas da Duralta (P2 a P4), quais regi√µes mostram crescimento consistente e quais est√£o em decl√≠nio ou vol√°teis?`,
                    'insight-heatmapMarketShare': `Nosso market share cresceu nas regi√µes 1, 2 e 3, mas caiu na 6 no P4, mesmo com vendas maiores. O que isso indica sobre a concorr√™ncia na Regi√£o 6?`,
                    'insight-regionalSales': `No P4, a Duralta dominou a Regi√£o 1 mas teve dificuldades nas regi√µes 5 e 6 contra a Luminous SA e a Empresa 5. Qual pode ser a causa da baixa performance na Regi√£o 5, considerando nosso pre√ßo competitivo?`,
                    'insight-precoVendas': `No P4, a Regi√£o 1 (pre√ßo $520) vendeu mais que a Regi√£o 4 (pre√ßo $500). O que isso sugere sobre a sensibilidade ao pre√ßo em diferentes mercados?`,
                    'insight-receitaRegiao': `Analisando a composi√ß√£o da receita da Duralta por regi√£o, qual foi o impacto da estrat√©gia de pre√ßo do P4 no faturamento da Regi√£o 1 em compara√ß√£o com as outras?`,
                    'insight-demanda': `A Duralta teve vendas perdidas em P2 e P3, mas n√£o em P4. Qual decis√£o operacional foi crucial para atender toda a demanda em P4?`,
                    'insight-productionCapacity': `No P4, a Duralta usou 25% de produ√ß√£o extra, operando no limite da capacidade. Qual √© a recomenda√ß√£o √≥bvia para o P5, que ter√° aumento de demanda?`,
                    'insight-materiaPrima': `O que o pico de compras emergenciais em P4, ausente em P3, revela sobre o nosso planejamento de estoque e seus custos?`,
                    'insight-custosEmergenciais': `Qual a rela√ß√£o direta entre a decis√£o de usar 25% de produ√ß√£o extra em P4 e o aumento expressivo nos custos de manuten√ß√£o e compras emergenciais?`,
                    'insight-lucroAlavancagem': `Como a decis√£o de tomar um grande empr√©stimo em P4, combinada com o aumento de pre√ßo, impactou o lucro operacional da Duralta? Foi uma boa estrat√©gia?`,
                    'insight-financeRadar': `Observando o Radar Financeiro, qual √© o principal ponto de aten√ß√£o para a Duralta em compara√ß√£o com a Luminous SA, e qual o nosso ponto forte?`,
                    'insight-motivacaoFatores': `A motiva√ß√£o dos funcion√°rios estagnou em 'Regular' no P4, apesar do PLR. Qual outro fator, vis√≠vel no gr√°fico, provavelmente impactou negativamente a motiva√ß√£o da equipe?`,
                    'insight-motivacaoPlr': `O investimento em PLR aumentou em P4, mas a motiva√ß√£o continuou 'Regular'. O que isso sugere sobre a efic√°cia do PLR como √∫nico fator de motiva√ß√£o em um cen√°rio de alta carga de trabalho?`,
                    'insight-marcaPropaganda': `Atingimos "Marca Forte" em P4 com o menor investimento em propaganda da s√©rie. O que isso indica sobre a maturidade da nossa marca e qual decis√£o estrat√©gica isso permite para o P5?`
                };

                const delay = (ms) => new Promise(res => setTimeout(res, ms));

                for (const [id, prompt] of Object.entries(insightPrompts)) {
                    generateInsight(id, prompt);
                    await delay(1500); 
                }
            }

            initializeDashboard();
        });
    </script>
</body>
</html>

